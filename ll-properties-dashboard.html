<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../ll-theme/ll-theme.html">
<link rel="import" href="../ll-theme/shared-styles.html">
<link rel="import" href="../ll-baseball-card/ll-baseball-card.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<script type="application/javascript" src="../lodash/lodash.js"></script>

<!--
An element providing a solution to no problem in particular.

Example:

    <ll-properties-dashboard></ll-properties-dashboard>

@demo
-->
<dom-module id="ll-properties-dashboard">

  <style>
    .view-switcher > .entypo[id*='view-switch'] {
      border: 1px solid #ccc;
      -webkit-border-radius: 8px;
      -moz-border-radius: 8px;
      border-radius: 8px;
      padding: 4px 7px;
      cursor: pointer;
      text-align: right;
      vertical-align: middle;
    }
    .view-switcher > label {
      color: var(--blue);
    }
    .view-switcher > .entypo.active {
      background: var(--blue);
      color: white;
    }
    .col-md-2 {
      width: auto;
    }
    .pencil {
      vertical-align: middle;
    }
    .filter-hr{
      margin-top:0;
    }

    .entypo.search{
      border:none;
      padding-left:0;
    }
  </style>

  <style include="shared-styles"></style>

  <template>

    <div class="row tab-control">
      <div class="filters filter col-lg-3 col-md-4 col-sm-6">
        <form action="#">
          <link rel="import" href="../integration-hub/ll-incremental-input/ll-incremental-input.html">
          <input class="search form-control" type="text" name="name", autocomplete="off", placeholder="Search properties by name", is="ll-incremental-input"/>
          <span class="entypo search"></span>
        </form>
      </div>

      <div class="view-switcher col-lg-9 col-md-8 col-sm-6" style="text-align:right;">
        <span style="border-right: 1px solid #ccc; height: 80px; vertical-align: middle; margin-right:10px; padding-right:10px;">
          <label class="main-metric">View: </label>
          <span id="grid-view-switch" class="entypo layout active"></span>
          <span id="list-view-switch" class="entypo numbered-list"></span>
        </span>
        <button class="btn btn-primary">Create New Property</button>
      </div>
    </div>
    <hr class="filter-hr"/>

    <div class="row">
      <div id="grid-view">
        <div class="col-md-12">
          <template is="dom-repeat" items="[[units]]" as="unit">
            <iron-ajax data-id$="{{unit.unitId}}" method="GET" on-response="_handleImageGet" on-error="_handleImageError" handle-as="json" ></iron-ajax>
            <div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
              <ll-baseball-card data-id$="{{unit.unitId}}" image-id="{{unit.unitId}}" title="{{unit.name}}" >
              </ll-baseball-card>
            </div>
          </template>
        </div>
      </div>

      <div id="list-view">
        <div class="col-md-12">
          <div class="table">
            <div class="table-header">
              <div class="table-row">
                <div class="table-cell">Property Name</div>
                <div class="table-cell">View/Edit</div>
              </div>
            </div>
            <div class="table-body">
              <template is="dom-repeat" items="[[units]]">
                <div class="table-row">
                  <div class="table-cell">{{item.name}}</div>
                  <div class="table-cell"><button on-click="_viewEditClicked" class="btn btn-link"><span class="entypo pencil"></span> VIEW/EDIT</button> </div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>
    </div>

  </template>

</dom-module>

<script>

  LLPropertiesDashboard = Polymer({

    is: 'll-properties-dashboard',

    properties: {
      /**
       * Collection of properties to be displayed
       */
      units: {
        type: Array,
        value: []
      },
      /**
       * Url for requesting images to be displayed in grid view
       */
      imageUrl: String,
      /**
       * The current view of the component. Can be one of: grid, view
       */
      _view: {
        type: String,
        value: 'grid'
      }
    },

    /**
     * Fired when the VIEW/EDIT link or a baseball card is clicked. Property object is passed on the event detail
     *
     * @event dashboard-view-edit-clicked
     */

    /**
     * Fired when the ajax request errors when retrieving the image url. Error object is passed on the event detail
     *
     * @event dashboard-error
     */

    listeners: {
      'll-baseball-card-clicked': '_baseballCardClicked'
    },

    // Element Lifecycle
    ready: function() {
      this.$['grid-view-switch'].addEventListener('click', this._switchToGridView.bind(this));
      this.$['list-view-switch'].addEventListener('click', this._switchToListView.bind(this));
      this._switchToGridView();
    },

    attached: function() {
      //Timeout is being used for now to get over an issue with polymer not loading all the way in integration-hub
      setTimeout(this._getImages.bind(this), 500);
    },

    // Element Behavior
    _getImages: function() {
      var self = this;
      this.units.forEach(function(unit) {
        var unitAjax = self.$$('iron-ajax[data-id="' + unit.unitId + '"]');
        unitAjax.url = self.imageUrl + 'images-api/public/v1/en/units/' + unit.unitId + '/default';
        unitAjax.generateRequest();
      });
    },

    _switchToGridView: function() {
      this._view = 'grid';
      this.$['grid-view-switch'].classList.add('active');
      this.$['list-view-switch'].classList.remove('active');

      this.$['grid-view'].classList.remove('hidden');
      this.$['list-view'].classList.add('hidden');
    },

    _switchToListView: function() {
      this._view = 'list';
      this.$['list-view-switch'].classList.add('active');
      this.$['grid-view-switch'].classList.remove('active');

      this.$['grid-view'].classList.add('hidden');
      this.$['list-view'].classList.remove('hidden');
    },

    _viewEditClicked: function(e) {
      this.fire('dashboard-view-edit-clicked', { obj: e.model.item });
    },

    _baseballCardClicked: function(e) {
      var unit = _.find(this.units, function(u) {
        return u.unitId === e.detail.id;
      });
      this.fire('dashboard-view-edit-clicked', { obj: unit });
    },

    _handleImageGet: function(evt, detail) {
      if(detail.response) {
        var unitId = detail.response.unitId;
        this.$$('ll-baseball-card[data-id="' + unitId + '"]').imageSource = detail.response.url;
      }
    },

    _handleImageError: function(evt, detail) {
      this.fire('dashboard-error', detail.error);
    }

  });

</script>
